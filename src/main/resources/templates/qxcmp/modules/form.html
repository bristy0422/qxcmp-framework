<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<body>
<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.AbstractForm"*/-->
<form th:fragment="form(component)" th:object="${__${component.object}__}"
      th:id="${component.id}" th:name="${component.name} ?: _" th:class="${component.getClassName()}"
      th:action="@{${component.action}} ?: _" th:method="${component.method ?: _}" th:enctype="${component.enctype}"
      th:autocomplete="not ${component.disableAutoComplete}" th:target="${component.target} ?: _">
    <th:block th:if="${component.infoMessage ne null}">
        <div th:replace="~{qxcmp/globals/components :: component(${component.infoMessage})}"></div>
    </th:block>
    <th:block th:if="${component.successMessage ne null}">
        <div th:replace="~{qxcmp/globals/components :: component(${component.successMessage})}"></div>
    </th:block>
    <th:block th:if="${component.warningMessage ne null}">
        <div th:replace="~{qxcmp/globals/components :: component(${component.warningMessage})}"></div>
    </th:block>
    <th:block th:if="${component.errorMessage ne null}">
        <div th:replace="~{qxcmp/globals/components :: component(${component.errorMessage})}"></div>
    </th:block>
    <th:block th:each="section : ${component.sections}">
        <div th:replace="~{:: section(${component}, ${section})}"></div>
    </th:block>
    <div class="submit section">
        <div th:replace="~{qxcmp/globals/components :: component(${component.submitButton})}"></div>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            var id = /*[[|#${component.id}|]]*/ "";
            var button = $(id).find(".submit.section button");

            $(id).submit(function () {
                $(button).addClass("disabled loading");
            });
        });
    </script>
</form>

<!--/*@thymesVar id="form" type="com.qxcmp.framework.web.view.modules.form.AbstractForm"*/-->
<!--/*@thymesVar id="section" type="com.qxcmp.framework.web.view.modules.form.AbstractFormSection"*/-->
<div th:fragment="section(form, section)" class="section">
    <div th:if="${#lists.size(form.sections) gt 1}" class="ui dividing small header" th:utext="${section.name}"></div>
    <th:block th:each="field : ${section.fields}">
        <div th:replace="~{qxcmp/globals/components :: component(${field})}"></div>
    </th:block>
</div>

<label th:fragment="field-label(component)">
    [[${component.label}]] <i th:if="not ${#strings.isEmpty(component.tooltip)}"
                              class="help circle outline link icon" th:attr="data-content=${component.tooltip}"></i>
</label>

<th:block th:fragment="field-common-script(component)">
    <script th:inline="javascript">
        $(document).ready(function () {
            var id = /*[[|#${component.id}|]]*/ "";
            var helpIcon = $(id).find(".help.icon");
            $(helpIcon).popup({position: 'top center'});
        });
    </script>
</th:block>

<th:block th:fragment="field-text-script(component)">
    <script th:inline="javascript">
        $(document).ready(function () {
            var id = /*[[|#${component.id}|]]*/ "";
            var input = $(id).find("input,textarea");
            var span = $(input).next("span");
            var maxLength = $(span).attr("data-max-length");

            span.text($(input).val().length + "/" + maxLength);

            $(input).focus(function () {
                span.css("display", "inherit")
            });

            $(input).blur(function () {
                span.css("display", "none")
            });

            $(input).on('keyup', function () {
                var count = $(this).val().length;
                span.text(count + "/" + maxLength);
            });
        });
    </script>
</th:block>

<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.field.TextInputField"*/-->
<div th:fragment="field-text-input(component)" th:id="${component.id}" th:class="${component.getClassName()}">
    <label th:replace="~{:: field-label(${component})}"></label>
    <input th:field="*{__${component.name}__}" th:placeholder="${component.placeholder}"
           th:maxlength="${(component.maxLength gt 0) ? component.maxLength : _}"
           th:autocomplete="not ${component.disableAutoComplete}" th:required="${component.required}"
           th:autofocus="${component.autoFocus}" th:readonly="${component.readOnly}"/>
    <span class="counter" style="display: none" th:attr="data-max-length=${component.maxLength}"></span>
    <script th:replace="~{:: field-common-script(${component})}"></script>
    <script th:replace="~{:: field-text-script(${component})}"></script>
</div>

<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.field.TextInputField"*/-->
<div th:fragment="field-password(component)" th:id="${component.id}" th:class="${component.getClassName()}">
    <label th:replace="~{:: field-label(${component})}"></label>
    <input th:field="*{__${component.name}__}" type="password" th:placeholder="${component.placeholder}"
           th:maxlength="${(component.maxLength gt 0) ? component.maxLength : _}"
           th:autocomplete="not ${component.disableAutoComplete}" th:required="${component.required}"
           th:autofocus="${component.autoFocus}" th:readonly="${component.readOnly}"/>
    <span class="counter" style="display: none" th:attr="data-max-length=${component.maxLength}"></span>
    <script th:replace="~{:: field-common-script(${component})}"></script>
    <script th:replace="~{:: field-text-script(${component})}"></script>
</div>

<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.field.TextAreaField"*/-->
<div th:fragment="field-text-area(component)" th:id="${component.id}" th:class="${component.getClassName()}">
    <label th:replace="~{:: field-label(${component})}"></label>
    <textarea th:field="*{__${component.name}__}" type="password" th:placeholder="${component.placeholder}"
              th:maxlength="${(component.maxLength gt 0) ? component.maxLength : _}" th:rows="${component.rows}"
              th:autocomplete="not ${component.disableAutoComplete}" th:required="${component.required}"
              th:autofocus="${component.autoFocus}" th:readonly="${component.readOnly}"></textarea>
    <span class="counter" style="display: none" th:attr="data-max-length=${component.maxLength}"></span>
    <script th:replace="~{:: field-common-script(${component})}"></script>
    <script th:replace="~{:: field-text-script(${component})}"></script>
</div>


<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.field.ImageCaptchaField"*/-->
<div th:fragment="field-captcha-image(component)" th:id="${component.id}" th:class="${component.getClassName()}">
    <label th:replace="~{:: field-label(${component})}"></label>
    <input th:field="*{__${component.name}__}" th:placeholder="${component.placeholder}"
           th:autocomplete="not ${component.disableAutoComplete}" th:required="${component.required}"
           th:autofocus="${component.autoFocus}" th:readonly="${component.readOnly}"/>
    <a class="captcha link" href="#">
        <img th:src="@{${component.captchaUrl}}"/>
    </a>
    <script th:replace="~{:: field-common-script(${component})}"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            var id = /*[[|#${component.id}|]]*/ "";
            var captchaLink = $(id).find(".captcha.link");
            var image = $(captchaLink).find("img");

            $(captchaLink).on("click", function () {
                var src = $(image).attr("src");
                $(image).attr("src", function () {
                    var timestamp = (new Date()).valueOf();
                    if ((src.indexOf("?") >= 0)) {
                        src = src.substring(0, src.indexOf('?')) + "?timestamp=" + timestamp;
                    } else {
                        src = src + "?timestamp=" + timestamp;
                    }
                    return src;
                })
            });
        });
    </script>
</div>

<!--/*@thymesVar id="component" type="com.qxcmp.framework.web.view.modules.form.field.PhoneCaptchaField"*/-->
<div th:fragment="field-captcha-phone(component)" th:id="${component.id}" th:class="${component.getClassName()}">
    <label th:replace="~{:: field-label(${component})}"></label>
    <div class="captcha section">
        <div th:if="${#strings.isEmpty(component.phoneField)}" class="phone number section">
            <input th:id="|${component.name}-phone|" placeholder="请输入接受短信的手机号码"/>
        </div>
        <div class="phone captcha section">
            <input th:field="*{__${component.name}__}" th:placeholder="${component.placeholder}"
                   th:autocomplete="not ${component.disableAutoComplete}" th:required="${component.required}"
                   th:autofocus="${component.autoFocus}" th:readonly="${component.readOnly}"/>
            <button class="ui basic secondary captcha button" type="button">获取短信验证码</button>
        </div>
    </div>
    <script th:inline="javascript">
        $(document).ready(function () {
            var id = /*[[|#${component.id}|]]*/ "";
            var phoneField = /*[['#' + (${#strings.isEmpty(component.phoneField)} ? ${component.name} + '-phone' : ${component.phoneField})]]*/"";
            var button = $(id).find(".captcha.button");
            var input = $(id).find(".phone.captcha.section input");
            var targetUrl = /*[[${component.captchaUrl}]]*/"";
            var interval = /*[[${component.interval}]]*/"";

            $(phoneField).on("keyup", function () {
                $(id).removeClass("error");
                $(input).val("");
            });

            $(button).on("click", function () {
                var phoneNumber = $(phoneField).val();

                if (!(/^1[34578]\d{9}$/.test(phoneNumber))) {
                    $(id).addClass("error");
                    $(input).val("手机号格式不正确");
                    return false;
                }

                $(button).addClass("disabled loading");

                $.ajax(targetUrl, {
                    type: "POST",
                    data: {
                        phone: phoneNumber
                    },
                    success: function () {

                        $(button).removeClass("loading");

                        var duration = interval;

                        var timer = setInterval(function () {
                            $(button).text(duration + "秒后可重发");
                            duration--;
                            if (duration === 0) {
                                clearInterval(timer);
                                $(button).text("重新发送");
                                $(button).removeClass("disabled loading");
                            }
                        }, 1000);
                    },
                    error: function (requset) {
                        $(id).addClass("error");
                        $(button).removeClass("disabled loading");
                        $(button).text("重新发送");
                        $(input).val(requset.responseText);
                    }
                });
            });
        });
    </script>
</div>

</body>
</html>